pipeline {
    agent any

    stages {
        stage('Cleanup') {
            steps {
                // Add cleanup steps here
            }
        }

        stage('Build And Push The Image To Docker Hub') {
            steps {
                script {
                    // Add your Docker build and push steps here
                }
            }
        }

        stage('Deploy Using Helm') {
            steps {
                script {
                    // Copy the Helm chart from GCS bucket
                    sh "gsutil cp gs://bucket-haknin/helm-project-0.1.12.tgz helm.tgz"
                    sh "tar -xzvf helm.tgz"

                    // Upgrade or install Helm release
                    def releaseName = "myapp"
                    def chartPath = "crypto-site/helm/crypto_flask_haknin" // Update this path
                    sh "helm repo update"
                    def releaseStatus = sh(
                        script: "helm status $releaseName",
                        returnStatus: true
                    ).trim()
                    if (releaseStatus == 0) {
                        echo "Helm release '$releaseName' already exists. Upgrading..."
                        sh "helm upgrade $releaseName $chartPath --set image.tag=1.10"
                    } else {
                        echo "Helm release '$releaseName' doesn't exist. Installing..."
                        sh "helm install $releaseName $chartPath --set image.tag=1.10"
                    }
                }
            }
        }

        stage('Test Website') {
            steps {
                // Add website testing steps here
            }
        }

        stage('Cleanup Kubernetes Resources') {
            steps {
                // Add cleanup of Kubernetes resources here
            }
        }

        // Add more stages as needed
    }
}
