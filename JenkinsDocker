def connectToServer(String ipAddress) {
    script {
        withCredentials([sshUserPrivateKey(credentialsId: 'ssh-ori109', keyFileVariable: 'ssh-ori109')]) {
            sshagent(['ssh-ori109']) {
                sh """
                ssh -o StrictHostKeyChecking=no -i ssh-ori109 ec2-user@$ipAddress '
                sudo yum install docker -y
                sudo systemctl restart docker
                sudo docker-compose up -p 5000:5000 haknin/crypto_docker:1.${BUILD_NUMBER}
                '
                """
            }
        }
    }
}

pipeline {
    agent any

    environment {
        EC2_IP_TEST = "18.158.60.91"
        EC2_IP_PROD = "52.29.248.134"
    }
    stages {

        stage('Cleanup') {
            steps {
                cleanWs()
                sh 'rm -rf *'
            }
        }
        stage('Clone') {
            steps {
                sh 'git clone https://github.com/Haknin/crypto-site.git'
            }
        }
        stage('Login to Docker Hub') {
            steps {
                withCredentials([
                    usernamePassword(credentialsId: 'docker_login', usernameVariable: 'DOCKER_HUB_USERNAME', passwordVariable: 'DOCKER_HUB_PASSWORD')
                ]) {
                    sh "docker login -u $DOCKER_HUB_USERNAME -p $DOCKER_HUB_PASSWORD"
                }
            }
        }
        stage('Build Docker Image') {
            steps {
                sh 'docker image prune -a'
                sh 'docker container prune -f'
                sh 'docker rmi \$(docker images -q) || true'
                sh 'cd crypto-site && docker build -t haknin/crypto_docker .'
            }
        }
        stage('Push to Docker Hub') {
            steps {
                sh 'docker push haknin/crypto_docker:latest'
            }
        }
        stage('Upload to EC2') {
            steps {
                script {
                    withCredentials([
                        sshUserPrivateKey(credentialsId: 'ssh-ori109', keyFileVariable: 'ssh-ori109')
                    ]) {
                        sshagent(['ssh-ori109']) {
                            sh """
                            ssh -o StrictHostKeyChecking=no ec2-user@$EC2_IP_PROD '
                            sudo yum install docker -y
                            sudo yum install git -y
                            docker-compose down
                            pwd
                            sudo rm -fr crypto-site
                            git clone https://github.com/Haknin/crypto-site.git
                            docker pull haknin/crypto_docker
                            sudo systemctl restart docker
                            sudo curl -L https://github.com/docker/compose/releases/download/1.22.0/docker-compose-\$(uname -s)-\$(uname -m) -o /usr/local/bin/docker-compose
                            sudo chmod +x /usr/local/bin/docker-compose
                            cd crypto-site
                            sudo docker-compose up -d
                            '
                            """
                        }
                    }
                }
            }
        }
    }
}
